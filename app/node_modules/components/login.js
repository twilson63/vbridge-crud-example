var ee = require('vflow-pouchdb');

var h = require('vbridge').h;
var page = require('page');

function session(state) {
  ee.on('session:created', function(doc) {
    //console.log(doc);
    state.set('user', doc.object);
    console.log('set user and direct to root web');
    page.redirect('/');
  });

  ee.on('session:error', function(doc) {
    state.set('error', doc.object.message );
    
  });

  page('/login', function(ctx) {
    state.set('ref', 'login');
  });

  page('/sessions/create', function(ctx) {
    ee.emit('post', {
      verb: 'create',
      object: ctx.body,
      actor: null
    })
  });
}

function render(state) {
  return h('div', [
    h('.row',[
      h('.twelve.columns', [
        'Hello World'
      ])
    ]),
    h('.row', [
      h('.twelve.columns', [
        h('form', { action:'/users/create', method: 'POST'}, [

          h('input', { type: 'hidden', name: 'type', value: 'session'}),
          h('fieldset', [
            h('label', 'Username'),
            h('input.u-full-width', {type: 'text', name: 'name'})  
          ]),
          h('fieldset', [
            h('label', 'Password'),
            h('input.u-full-width', {type: 'password', name: 'password'})  
          ]),
          h('input.button.button-primary', { type: 'submit', value: 'Login' } ),
          h('span', ' | '),
          h('a.button.button-primary', { href: '/signup'}, 'Register')
        ])
      ])
    ])
  ])
}

session.render = render;
module.exports = session;