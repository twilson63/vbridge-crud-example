//var ee = require('vflow-pouchdb');
var ee = require('../../flow');
var h = require('vbridge').h;
var page = require('page');

function session(state) {
  ee.on('session:created', function(doc) {
    state.set('error', null);
    state.set('user', doc.object);
    page.redirect('/');
  });

  ee.on('session:error', function(doc) {
    state.set('error', 'ERROR: ' + doc.object.message );    
  });

  page('/login', function(ctx) {
    state.set('ref', 'login');
  });

  page('/sessions/create', function(ctx) {
    ee.emit('post', {
      verb: 'create',
      object: ctx.body,
      actor: null
    })
  });
}

function render(state) {
  return h('div', [
    h('.row',[
      h('.twelve.columns', [
        state.get('error') ? h('span', state.get('error') ) : null
      ])
    ]),
    h('.row', [
      h('.twelve.columns', [
        h('form', { action:'/users/create', method: 'POST'}, [

          h('input', { type: 'hidden', name: 'type', value: 'session'}),
          h('fieldset', [
            h('label', 'Username'),
            h('input.u-full-width', {type: 'text', name: 'name'})  
          ]),
          h('fieldset', [
            h('label', 'Password'),
            h('input.u-full-width', {type: 'password', name: 'password'})  
          ]),
          h('input.button.button-primary', { type: 'submit', value: 'Login' } ),
          h('span', ' | '),
          h('a.button.button-primary', { href: '/signup'}, 'Register')
        ])
      ])
    ])
  ])
}

session.render = render;
module.exports = session;