var ee = require('vflow-pouchdb');
var pouchdb = require('pouchdb');
pouchdb.plugin(require('pouchdb-authentication'));
var db = pouchdb(window.location.origin + '/db');

module.exports = function() {
  ee.on('user:create', function(doc) {
    db.signup(doc.object.name, doc.object.password, function(err, res) {
      if (err) {
        if (err.name === 'conflict') {
          ee.emit('post', {
            verb: 'error',
            object: {
              type: 'user',
              message: 'user already exists'
            }
          });
        } else if (err.name === 'forbidden') {
          ee.emit('post', {
            verb: 'error',
            object: {
              type: 'user',
              message: 'user name forbidden'
            }
          });
        }
        return;
      }
      var e = {
        verb: 'created',
        object: doc.object
      };
      ee.emit('user:created', e);
    })
  });
};