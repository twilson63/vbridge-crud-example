var ee = require('vflow-pouchdb');
var pouchdb = require('pouchdb');
pouchdb.plugin(require('pouchdb-authentication'));

var db = pouchdb(window.location.origin + '/db');

module.exports = function() {
  ee.on('session:create', function(doc) {
    // everyone can login
    console.log(doc.object);
    db.login(doc.object.name, doc.object.password, function(err, res) {
      if (err) { 
        ee.emit('session:error', {
          verb: 'error',
          object: {
            type: 'session',
            message: err.reason
          }
        });
        return console.log(err);
      }
      console.log(res);
      var e = {
        verb: 'created',
        object: {
          name: doc.object.name
        }
      };
      ee.emit('session:created', e);
    });
  });
};